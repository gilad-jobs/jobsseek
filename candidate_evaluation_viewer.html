<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Candidate Evaluation Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f4f6f8; }
    .card { margin-bottom: 2rem; }
    .highlight { color: #0a66c2; font-weight: bold; }
    .sub { font-size: 0.875em; color: #6c757d; }
    .chart-title { font-size: 1.25rem; margin-bottom: 0.5rem; }
    .chart-container { padding: 1rem; background: white; border-radius: 0.5rem; box-shadow: 0 0 0.5rem rgba(0,0,0,0.05); }
    #jsonDropZone.border { transition: border 0.2s ease-in-out; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="mb-4">
      <button id="toggleInput" class="btn btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#jsonCollapse" aria-expanded="true" aria-controls="jsonCollapse">
        Hide JSON Input
      </button>
      <div class="collapse show" id="jsonCollapse">
        <div id="jsonDropZone" class="border p-3 bg-white rounded">
          <label for="jsonInput" class="form-label">Paste or drag evaluation JSON here:</label>
          <textarea id="jsonInput" class="form-control" rows="10" placeholder="Drop JSON text here or paste manually..."></textarea>
        </div>
      </div>
    </div>

    <div id="header">
      <h1 class="mb-1" id="candidateName">Candidate Evaluation Viewer</h1>
      <h5 class="text-muted mb-4" id="roleTitle"></h5>
    </div>

    <div id="criticalFailAlert"></div>
    <div id="summaryBlock" class="mb-4"></div>
    <div id="decisionBox"></div>
    <div id="metadata" class="mb-4"></div>
    <div id="output"></div>

    <div id="chartContainer" class="row">
      <div class="col-md-6">
        <div class="chart-container">
          <div class="chart-title">Must-Have Criteria</div>
          <canvas id="mustHaveChart"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="chart-container">
          <div class="chart-title">Advantage Criteria</div>
          <canvas id="advantageChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    function renderEvaluation(json) {
      let data;
      try { data = JSON.parse(json); } 
      catch { document.getElementById('output').innerHTML = '<div class="alert alert-danger">Invalid JSON</div>'; return; }

      const categories = data.categories || [];
      const fitRate = data.fitRate || '?';
      const potentialScore = data.potentialScore || '?';
      const successPrediction = data.success_prediction || '?';
      const basedOn = data.based_on || '';
      const tone = data.personality_tone || '';
      const consistency = data.consistency_check?.passed ? 'Passed' : 'Failed';
      const indicators = data.missing_indicators?.length ? data.missing_indicators.map(m => `<li>${m}</li>`).join('') : '<li>None</li>';
      const summary = data.summary || '';
      const decision = data.decision || '';
      if (data.candidate_name) document.getElementById("candidateName").textContent = data.candidate_name;
      if (data.role_name) document.getElementById("roleTitle").textContent = data.role_name;

      const hasCriticalFail = categories.some(c => c.is_critical_fail);
      document.getElementById('criticalFailAlert').innerHTML = hasCriticalFail
        ? '<div class="alert alert-danger text-center fs-4 fw-bold">CRITICAL FAIL DETECTED</div>'
        : '';

      document.getElementById('summaryBlock').innerHTML = summary
        ? `<div class="card"><div class="card-body"><h5>Candidate Summary</h5><p>${summary}</p></div></div>`
        : '';

      document.getElementById('decisionBox').innerHTML = decision
        ? `<div class="row mb-4"><div class="col-12 text-center"><div class="card bg-light"><div class="card-body"><h4 class="fw-bold text-primary">Decision</h4><p class="fs-4 highlight">${decision}</p></div></div></div></div>`
        : '';

      document.getElementById("metadata").innerHTML = `
        <div class="row g-3">
          <div class="col-md-4">
            <div class="card text-center"><div class="card-body"><strong class="fs-5">Fit Rate:</strong><br><span class="${fitRate > 80 ? 'text-success fw-bold' : ''}">${fitRate}%</span></div></div>
          </div>
          <div class="col-md-4">
            <div class="card text-center"><div class="card-body"><strong class="fs-5">Potential Score:</strong><br><span class="${potentialScore > 80 ? 'text-success fw-bold' : ''}">${potentialScore}%</span></div></div>
          </div>
          <div class="col-md-4">
            <div class="card text-center"><div class="card-body"><strong class="fs-5">Success Prediction:</strong><br><span class="${successPrediction > 80 ? 'text-success fw-bold' : ''}">${successPrediction}%</span></div></div>
          </div>
          <div class="col-md-6"><div class="card"><div class="card-body"><strong>Personality Tone:</strong> ${tone}</div></div></div>
          <div class="col-md-6"><div class="card"><div class="card-body"><strong>Consistency Check:</strong> <span class="${consistency === 'Passed' ? 'text-success fw-bold' : 'text-danger'}">${consistency}</span></div></div></div>
          <div class="col-md-12"><div class="card"><div class="card-body"><strong>Missing Indicators:</strong><ul class="text-danger">${indicators}</ul></div></div></div>
        </div>`;

      const rows = categories.map((c, i) => {
        const subs = (c.sub_criteria || []).map(sub => `<div class="sub">â€¢ ${sub.name}: ${sub.score} (${sub.confidence})</div>`).join('');
        return `<tr>
          <th scope="row">${i + 1}</th>
          <td>${c.name}<br/><span class="sub text-${c.type === 'must_have' ? 'danger' : 'success'} fw-bold">${c.type === 'must_have' ? 'MUST' : 'ADVANTAGE'}</span></td>
          <td>${c.weight}</td>
          <td>${c.score}</td>
          <td>${c.confidence}</td>
          <td>${c.recency || 'N/A'}</td>
          <td>${c.duration || 'N/A'}</td>
          <td>${c.is_critical_fail ? '<span class="text-danger fw-bold">Yes</span>' : 'No'}</td>
          <td>${c.reason || ''}${subs}</td>
        </tr>`;
      }).join('');

      document.getElementById('output').innerHTML = `
        <div class="card"><div class="card-body">
        <h5 class="card-title">Evaluation Summary</h5>
        <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Weight</th>
              <th>Score</th>
              <th>Confidence</th>
              <th>Recency</th>
              <th>Duration</th>
              <th>Critical Fail</th>
              <th>Reason & Sub-Criteria</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        </div></div></div>`;

      const mustHave = categories.filter(c => c.type === 'must_have');
      const advantage = categories.filter(c => c.type !== 'must_have');
      renderRadarChart('mustHaveChart', mustHave);
      renderRadarChart('advantageChart', advantage);

      // Collapse input after rendering
      const bsCollapse = bootstrap.Collapse.getOrCreateInstance(document.getElementById('jsonCollapse'));
      bsCollapse.hide();
      document.getElementById("toggleInput").textContent = "Show JSON Input";
    }

    function renderRadarChart(canvasId, categories) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = categories.map(c => c.name);
      const scores = categories.map(c => c.score);
      const weights = categories.map(c => c.weight * 100);
      if (window[canvasId + 'Instance']) window[canvasId + 'Instance'].destroy();

      window[canvasId + 'Instance'] = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Score', data: scores, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: '#0a66c2', borderWidth: 2 },
            { label: 'Weight (scaled)', data: weights, backgroundColor: 'rgba(255, 206, 86, 0.2)', borderColor: '#ffc107', borderWidth: 2 }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: false }
          },
          scales: { r: { beginAtZero: true, max: 100 } }
        }
      });
    }

    const jsonInput = document.getElementById('jsonInput');
    jsonInput.addEventListener('input', () => {
      const raw = jsonInput.value.trim();
      if (raw) renderEvaluation(raw);
    });

    document.getElementById("toggleInput").addEventListener("click", () => {
      const isShown = document.getElementById("jsonCollapse").classList.contains("show");
      document.getElementById("toggleInput").textContent = isShown ? "Show JSON Input" : "Hide JSON Input";
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
